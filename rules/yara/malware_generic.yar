/*
    Generic Malware Detection Rules
    Detects common malware patterns and techniques
*/

rule Suspicious_PowerShell_Download {
    meta:
        description = "Detects PowerShell download cradles"
        severity = "high"
        mitre = "T1059.001,T1105"
        author = "SOC Investigator"
    strings:
        $ps1 = "DownloadString" ascii wide nocase
        $ps2 = "DownloadFile" ascii wide nocase
        $ps3 = "DownloadData" ascii wide nocase
        $ps4 = "Net.WebClient" ascii wide nocase
        $ps5 = "Invoke-WebRequest" ascii wide nocase
        $ps6 = "wget" ascii wide nocase
        $ps7 = "curl" ascii wide nocase
        $ps8 = "IWR" ascii wide nocase
        $ps9 = "Start-BitsTransfer" ascii wide nocase
        $iex1 = "IEX" ascii wide
        $iex2 = "Invoke-Expression" ascii wide nocase
    condition:
        any of ($ps*) and any of ($iex*)
}

rule Suspicious_PowerShell_Encoded {
    meta:
        description = "Detects Base64 encoded PowerShell commands"
        severity = "high"
        mitre = "T1059.001,T1027"
        author = "SOC Investigator"
    strings:
        $enc1 = "-EncodedCommand" ascii wide nocase
        $enc2 = "-enc" ascii wide nocase
        $enc3 = "-e " ascii wide nocase
        $enc4 = "FromBase64String" ascii wide nocase
        $enc5 = "[Convert]::FromBase64" ascii wide nocase
        $hidden = "-WindowStyle Hidden" ascii wide nocase
        $bypass = "-ExecutionPolicy Bypass" ascii wide nocase
        $nop = "-nop" ascii wide nocase
    condition:
        any of ($enc*) or ($hidden and $bypass) or ($nop and any of ($enc*))
}

rule Suspicious_CMD_Execution {
    meta:
        description = "Detects suspicious command line patterns"
        severity = "medium"
        mitre = "T1059.003"
        author = "SOC Investigator"
    strings:
        $cmd1 = "cmd /c" ascii wide nocase
        $cmd2 = "cmd.exe /c" ascii wide nocase
        $cmd3 = "cmd /k" ascii wide nocase
        $susp1 = "whoami" ascii wide nocase
        $susp2 = "net user" ascii wide nocase
        $susp3 = "net localgroup" ascii wide nocase
        $susp4 = "systeminfo" ascii wide nocase
        $susp5 = "tasklist" ascii wide nocase
        $susp6 = "ipconfig /all" ascii wide nocase
        $susp7 = "netstat" ascii wide nocase
        $susp8 = "reg query" ascii wide nocase
    condition:
        any of ($cmd*) and 2 of ($susp*)
}

rule Mimikatz_Strings {
    meta:
        description = "Detects Mimikatz credential dumping tool"
        severity = "critical"
        mitre = "T1003.001"
        author = "SOC Investigator"
    strings:
        $s1 = "sekurlsa::logonpasswords" ascii wide nocase
        $s2 = "sekurlsa::wdigest" ascii wide nocase
        $s3 = "lsadump::sam" ascii wide nocase
        $s4 = "lsadump::dcsync" ascii wide nocase
        $s5 = "kerberos::golden" ascii wide nocase
        $s6 = "privilege::debug" ascii wide nocase
        $s7 = "mimikatz" ascii wide nocase
        $s8 = "gentilkiwi" ascii wide nocase
        $s9 = "mimilib" ascii wide nocase
        $s10 = "sekurlsa::" ascii wide nocase
    condition:
        2 of them
}

rule Cobalt_Strike_Beacon {
    meta:
        description = "Detects Cobalt Strike Beacon patterns"
        severity = "critical"
        mitre = "T1071.001"
        author = "SOC Investigator"
    strings:
        $s1 = "%s.4444" ascii
        $s2 = "%s.80" ascii
        $s3 = "%s.443" ascii
        $s4 = "beacon" ascii wide nocase
        $s5 = "ReflectiveLoader" ascii wide
        $s6 = "%02d/%02d/%02d %02d:%02d:%02d" ascii
        $s7 = "could not spawn" ascii
        $config1 = { 00 01 00 01 00 02 ?? ?? 00 02 00 01 00 02 ?? ?? }
        $config2 = { 69 68 69 68 69 6b }
    condition:
        3 of ($s*) or any of ($config*)
}

rule Metasploit_Meterpreter {
    meta:
        description = "Detects Metasploit Meterpreter payload"
        severity = "critical"
        mitre = "T1059"
        author = "SOC Investigator"
    strings:
        $s1 = "meterpreter" ascii wide nocase
        $s2 = "stdapi" ascii wide
        $s3 = "priv" ascii wide
        $s4 = "extapi" ascii wide
        $s5 = "ReflectiveDLLInject" ascii wide
        $s6 = "metasploit" ascii wide nocase
        $s7 = "reverse_tcp" ascii wide nocase
        $s8 = "reverse_http" ascii wide nocase
        $s9 = "shell_reverse_tcp" ascii wide
    condition:
        2 of them
}

rule Ransomware_Note_Indicators {
    meta:
        description = "Detects ransomware note indicators"
        severity = "critical"
        mitre = "T1486"
        author = "SOC Investigator"
    strings:
        $note1 = "your files have been encrypted" ascii wide nocase
        $note2 = "pay the ransom" ascii wide nocase
        $note3 = "bitcoin" ascii wide nocase
        $note4 = "decrypt your files" ascii wide nocase
        $note5 = "restore your files" ascii wide nocase
        $note6 = "send bitcoin" ascii wide nocase
        $note7 = "pay in bitcoin" ascii wide nocase
        $note8 = "your personal id" ascii wide nocase
        $note9 = "tor browser" ascii wide nocase
        $note10 = ".onion" ascii wide nocase
        $ext1 = ".locked" ascii wide nocase
        $ext2 = ".encrypted" ascii wide nocase
        $ext3 = ".crypto" ascii wide nocase
    condition:
        3 of ($note*) or (any of ($note*) and any of ($ext*))
}

rule Suspicious_PE_Sections {
    meta:
        description = "Detects PE with suspicious section names"
        severity = "medium"
        mitre = "T1027.002"
        author = "SOC Investigator"
    strings:
        $mz = "MZ"
        $sec1 = "UPX0" ascii
        $sec2 = "UPX1" ascii
        $sec3 = ".ndata" ascii
        $sec4 = ".vmp0" ascii
        $sec5 = ".vmp1" ascii
        $sec6 = ".themida" ascii
        $sec7 = "MPRESS1" ascii
        $sec8 = "MPRESS2" ascii
        $sec9 = ".petite" ascii
        $sec10 = ".aspack" ascii
    condition:
        $mz at 0 and 2 of ($sec*)
}

rule Suspicious_Macro_Indicators {
    meta:
        description = "Detects suspicious Office macro indicators"
        severity = "high"
        mitre = "T1059.005"
        author = "SOC Investigator"
    strings:
        $auto1 = "AutoOpen" ascii wide nocase
        $auto2 = "AutoExec" ascii wide nocase
        $auto3 = "Auto_Open" ascii wide nocase
        $auto4 = "Document_Open" ascii wide nocase
        $auto5 = "Workbook_Open" ascii wide nocase
        $shell1 = "Shell" ascii wide
        $shell2 = "WScript.Shell" ascii wide nocase
        $shell3 = "ShellExecute" ascii wide nocase
        $shell4 = "CreateObject" ascii wide nocase
        $ps = "powershell" ascii wide nocase
        $cmd = "cmd.exe" ascii wide nocase
    condition:
        any of ($auto*) and (any of ($shell*) or $ps or $cmd)
}

rule Webshell_Generic {
    meta:
        description = "Detects generic webshell patterns"
        severity = "critical"
        mitre = "T1505.003"
        author = "SOC Investigator"
    strings:
        $php1 = "<?php" ascii nocase
        $asp1 = "<%@" ascii nocase
        $asp2 = "<%" ascii nocase
        $jsp1 = "<%@page" ascii nocase
        $eval1 = "eval(" ascii nocase
        $eval2 = "assert(" ascii nocase
        $eval3 = "execute(" ascii nocase
        $shell1 = "shell_exec" ascii nocase
        $shell2 = "passthru" ascii nocase
        $shell3 = "system(" ascii nocase
        $shell4 = "exec(" ascii nocase
        $shell5 = "popen(" ascii nocase
        $shell6 = "proc_open" ascii nocase
        $cmd1 = "$_GET" ascii nocase
        $cmd2 = "$_POST" ascii nocase
        $cmd3 = "$_REQUEST" ascii nocase
        $b64 = "base64_decode" ascii nocase
    condition:
        (any of ($php*, $asp*, $jsp*)) and
        (any of ($eval*) or any of ($shell*)) and
        (any of ($cmd*) or $b64)
}

rule Reverse_Shell_Indicators {
    meta:
        description = "Detects reverse shell indicators"
        severity = "critical"
        mitre = "T1059"
        author = "SOC Investigator"
    strings:
        $bash1 = "/bin/bash -i" ascii wide
        $bash2 = "/bin/sh -i" ascii wide
        $nc1 = "nc -e" ascii wide
        $nc2 = "ncat -e" ascii wide
        $nc3 = "netcat -e" ascii wide
        $python1 = "socket.socket" ascii wide
        $python2 = "subprocess.call" ascii wide
        $python3 = "pty.spawn" ascii wide
        $perl1 = "perl -e" ascii wide
        $ruby1 = "TCPSocket" ascii wide
        $php1 = "fsockopen" ascii wide
        $ps1 = "TCPClient" ascii wide
        $ps2 = "GetStream" ascii wide
    condition:
        2 of them
}

rule Credential_Harvesting {
    meta:
        description = "Detects credential harvesting patterns"
        severity = "high"
        mitre = "T1555"
        author = "SOC Investigator"
    strings:
        $cred1 = "Login Data" ascii wide
        $cred2 = "cookies.sqlite" ascii wide nocase
        $cred3 = "signons.sqlite" ascii wide nocase
        $cred4 = "logins.json" ascii wide nocase
        $cred5 = "key3.db" ascii wide nocase
        $cred6 = "key4.db" ascii wide nocase
        $cred7 = "Credentials" ascii wide
        $cred8 = "vault" ascii wide nocase
        $path1 = "\\Google\\Chrome\\User Data" ascii wide nocase
        $path2 = "\\Mozilla\\Firefox\\Profiles" ascii wide nocase
        $path3 = "\\Microsoft\\Credentials" ascii wide nocase
        $api1 = "CryptUnprotectData" ascii wide
        $api2 = "CredEnumerate" ascii wide
    condition:
        3 of ($cred*) or (any of ($path*) and any of ($api*))
}

rule Keylogger_Indicators {
    meta:
        description = "Detects keylogger indicators"
        severity = "high"
        mitre = "T1056.001"
        author = "SOC Investigator"
    strings:
        $api1 = "GetAsyncKeyState" ascii wide
        $api2 = "SetWindowsHookEx" ascii wide
        $api3 = "GetKeyState" ascii wide
        $api4 = "GetKeyboardState" ascii wide
        $api5 = "RegisterRawInputDevices" ascii wide
        $log1 = "keylog" ascii wide nocase
        $log2 = "keystroke" ascii wide nocase
        $log3 = "keyboard" ascii wide nocase
    condition:
        2 of ($api*) or (any of ($api*) and any of ($log*))
}
