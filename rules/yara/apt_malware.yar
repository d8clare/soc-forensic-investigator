/*
    APT and Advanced Malware Detection Rules
    Detects known APT tools and advanced threats
*/

rule APT_Lazarus_Loader {
    meta:
        description = "Detects Lazarus Group loader patterns"
        severity = "critical"
        mitre = "T1059,T1106"
        author = "SOC Investigator"
        apt = "Lazarus"
    strings:
        $s1 = "VirtualAlloc" ascii wide
        $s2 = "VirtualProtect" ascii wide
        $s3 = "CreateThread" ascii wide
        $s4 = {8B 45 ?? 83 C0 ?? 89 45 ?? 8B 4D ?? 03 4D}
        $pdb1 = "Release\\Loader" ascii
        $pdb2 = "Debug\\injector" ascii
    condition:
        all of ($s*) or any of ($pdb*)
}

rule APT_Emotet_Loader {
    meta:
        description = "Detects Emotet loader characteristics"
        severity = "critical"
        mitre = "T1027"
        author = "SOC Investigator"
        malware = "Emotet"
    strings:
        $mz = "MZ"
        $s1 = "BCryptDecrypt" ascii wide
        $s2 = "BCryptEncrypt" ascii wide
        $s3 = "InternetOpenA" ascii wide
        $s4 = "HttpSendRequestA" ascii wide
        $mutex1 = "Global\\" ascii wide
        $cfg = { 68 ?? ?? ?? 00 68 ?? ?? ?? 00 68 ?? ?? ?? 00 E8 }
    condition:
        $mz at 0 and 3 of ($s*) and ($mutex1 or $cfg)
}

rule APT_TrickBot {
    meta:
        description = "Detects TrickBot banking trojan"
        severity = "critical"
        mitre = "T1055,T1106"
        author = "SOC Investigator"
        malware = "TrickBot"
    strings:
        $s1 = "moduleconfig" ascii wide nocase
        $s2 = "mcconf" ascii wide nocase
        $s3 = "systeminfo" ascii wide nocase
        $s4 = "pwgrab" ascii wide nocase
        $s5 = "injectDll" ascii wide nocase
        $s6 = "mailsearcher" ascii wide nocase
        $cfg = "group_tag" ascii wide nocase
        $bot = "bot_id" ascii wide nocase
    condition:
        3 of ($s*) or ($cfg and $bot)
}

rule APT_QakBot {
    meta:
        description = "Detects QakBot/Qbot banking trojan"
        severity = "critical"
        mitre = "T1055"
        author = "SOC Investigator"
        malware = "QakBot"
    strings:
        $s1 = "spx77" ascii wide
        $s2 = "spx78" ascii wide
        $s3 = "obama" ascii wide nocase
        $s4 = "tr02" ascii wide
        $s5 = "stager" ascii wide nocase
        $c2_pattern = { 68 ?? ?? ?? ?? 68 ?? ?? ?? ?? 6A 00 E8 }
        $inject = "ntdll.dll" ascii wide
    condition:
        3 of them
}

rule APT_Agent_Tesla {
    meta:
        description = "Detects Agent Tesla infostealer"
        severity = "critical"
        mitre = "T1555,T1056"
        author = "SOC Investigator"
        malware = "AgentTesla"
    strings:
        $dotnet = ".NET Framework" ascii wide
        $s1 = "smtp.gmail.com" ascii wide
        $s2 = "smtp.mail.ru" ascii wide
        $s3 = "smtp.yandex.com" ascii wide
        $s4 = "WebPanel" ascii wide
        $s5 = "keylog" ascii wide nocase
        $s6 = "screenshot" ascii wide nocase
        $s7 = "clipboard" ascii wide nocase
        $ftp = "ftp://" ascii wide nocase
    condition:
        $dotnet and 3 of ($s*) or ($ftp and 2 of ($s*))
}

rule APT_Remcos_RAT {
    meta:
        description = "Detects Remcos Remote Access Tool"
        severity = "critical"
        mitre = "T1219"
        author = "SOC Investigator"
        malware = "Remcos"
    strings:
        $s1 = "Remcos" ascii wide nocase
        $s2 = "Breaking-Security" ascii wide nocase
        $s3 = "licence" ascii wide nocase
        $s4 = "keylogger" ascii wide nocase
        $mutex = "Remcos_Mutex" ascii wide nocase
        $cfg = "SETTINGS" ascii wide
        $ver = { 52 65 6D 63 6F 73 20 76 }
    condition:
        3 of them
}

rule APT_AsyncRAT {
    meta:
        description = "Detects AsyncRAT remote access trojan"
        severity = "critical"
        mitre = "T1219"
        author = "SOC Investigator"
        malware = "AsyncRAT"
    strings:
        $s1 = "AsyncClient" ascii wide nocase
        $s2 = "Asynchronous" ascii wide nocase
        $s3 = "pastebin" ascii wide nocase
        $s4 = "ABORNAHOST" ascii wide
        $s5 = "AsyncMutex" ascii wide nocase
        $s6 = "ClientSocket" ascii wide
        $dotnet = "mscorlib" ascii wide
    condition:
        $dotnet and 2 of ($s*)
}

rule APT_NjRAT {
    meta:
        description = "Detects njRAT remote access trojan"
        severity = "critical"
        mitre = "T1219"
        author = "SOC Investigator"
        malware = "njRAT"
    strings:
        $s1 = "njRAT" ascii wide nocase
        $s2 = "njq8" ascii wide
        $s3 = "im523" ascii wide
        $s4 = "kl.dat" ascii wide
        $s5 = "YOUCODE" ascii wide
        $s6 = "netsh firewall add" ascii wide nocase
        $mutex = "750_Mutex" ascii wide
    condition:
        3 of them
}

rule APT_DarkComet {
    meta:
        description = "Detects DarkComet RAT"
        severity = "critical"
        mitre = "T1219"
        author = "SOC Investigator"
        malware = "DarkComet"
    strings:
        $s1 = "DarkComet" ascii wide nocase
        $s2 = "DC_Mutex" ascii wide
        $s3 = "IDOK" ascii wide
        $s4 = "EditSoftware" ascii wide nocase
        $s5 = "#KCMDDC" ascii wide
        $s6 = "FHOOK" ascii wide
        $s7 = "DCRAT" ascii wide
    condition:
        3 of them
}

rule APT_IcedID {
    meta:
        description = "Detects IcedID/BokBot banking trojan"
        severity = "critical"
        mitre = "T1055,T1106"
        author = "SOC Investigator"
        malware = "IcedID"
    strings:
        $s1 = "license.dat" ascii wide nocase
        $s2 = ".tmp" ascii wide
        $s3 = "sqlite3" ascii wide
        $cfg1 = { 8D ?? ?? ?? ?? ?? 50 8D ?? ?? ?? ?? ?? 50 }
        $loader = { 55 8B EC 83 EC ?? 53 56 57 8D ?? ?? ?? FF 15 }
    condition:
        3 of them
}

rule APT_Dridex {
    meta:
        description = "Detects Dridex banking trojan"
        severity = "critical"
        mitre = "T1055"
        author = "SOC Investigator"
        malware = "Dridex"
    strings:
        $s1 = "botnet" ascii wide nocase
        $s2 = "webinjects" ascii wide nocase
        $xor_loop = { 8A ?? ?? 32 ?? ?? 88 ?? ?? 4? 75 F? }
        $api1 = "NtQueryInformationProcess" ascii wide
        $api2 = "NtQuerySystemInformation" ascii wide
    condition:
        2 of ($s*) or ($xor_loop and any of ($api*))
}

rule APT_BazarLoader {
    meta:
        description = "Detects BazarLoader/BazarBackdoor"
        severity = "critical"
        mitre = "T1071"
        author = "SOC Investigator"
        malware = "BazarLoader"
    strings:
        $s1 = "WinHttpOpen" ascii wide
        $s2 = "WinHttpConnect" ascii wide
        $s3 = "WinHttpOpenRequest" ascii wide
        $s4 = ".bazar" ascii wide nocase
        $dns = { 68 ?? ?? ?? ?? FF 15 ?? ?? ?? ?? 85 C0 }
    condition:
        all of ($s*) or (3 of ($s*) and $dns)
}

rule APT_PlugX {
    meta:
        description = "Detects PlugX RAT (APT tool)"
        severity = "critical"
        mitre = "T1055,T1071"
        author = "SOC Investigator"
        malware = "PlugX"
        apt = "Various APT Groups"
    strings:
        $s1 = "Plug1.0" ascii wide
        $s2 = "plug25" ascii wide
        $s3 = "XV1120" ascii wide
        $s4 = "boot.ldr" ascii wide
        $shellcode = { 60 89 E5 31 D2 64 8B 52 30 8B 52 0C }
        $cfg = { 68 00 10 00 00 68 ?? ?? ?? ?? 6A 40 }
    condition:
        2 of ($s*) or $shellcode or $cfg
}

rule APT_ShadowPad {
    meta:
        description = "Detects ShadowPad backdoor"
        severity = "critical"
        mitre = "T1071,T1106"
        author = "SOC Investigator"
        malware = "ShadowPad"
    strings:
        $s1 = "SHADOWPAD" ascii wide nocase
        $s2 = "winnti" ascii wide nocase
        $s3 = "ntdll.dll" ascii wide
        $s4 = "kernel32.dll" ascii wide
        $xor = { 8A ?? 34 ?? 88 ?? 4? ?? F? }
        $api_hash = { 68 ?? ?? ?? ?? E8 ?? ?? ?? ?? 89 ?? 68 }
    condition:
        2 of ($s*) and ($xor or $api_hash)
}
